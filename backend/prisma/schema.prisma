// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         UserRole
  active       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  createdDtrCases    DtrCase[]     @relation("DtrCreatedBy")
  assignedDtrCases   DtrCase[]     @relation("DtrAssignedTo")
  closedDtrCases     DtrCase[]     @relation("DtrClosedBy")
  createdRmaCases    RmaCase[]     @relation("RmaCreatedBy")
  assignedRmaCases   RmaCase[]     @relation("RmaAssignedTo")
  auditLogs          AuditLog[]
  notifications      Notification[]
  notificationPreferences NotificationPreference?
  createdTemplates   CaseTemplate[] @relation("TemplateCreatedBy")
  savedSearches      SavedSearch[]
  createdRules        AssignmentRule[] @relation("RuleCreatedBy")
  uploadedAttachments CaseAttachment[]

  @@map("users")
}

enum UserRole {
  staff
  engineer
  manager
  admin
}

// ============================================
// MASTER DATA
// ============================================

model Site {
  id        String   @id @default(uuid())
  siteName  String   @map("site_name")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  audis     Audi[]
  dtrCases  DtrCase[]
  rmaCases  RmaCase[]

  @@map("sites")
}

model ProjectorModel {
  id             String   @id @default(uuid())
  modelNo        String   @unique @map("model_no")
  manufacturer   String?
  specifications String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  projectors Projector[]
  parts      Part[]

  @@map("projector_models")
}

model Projector {
  id                String   @id @default(uuid())
  serialNumber      String   @unique @map("serial_number")
  projectorModelId  String   @map("projector_model_id")
  status            String   @default("active") // "active", "maintenance", "retired"
  installationDate  DateTime? @map("installation_date")
  notes             String?  @db.Text
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  projectorModel ProjectorModel @relation(fields: [projectorModelId], references: [id], onDelete: Restrict)
  audis          Audi[]
  transfers      ProjectorTransfer[]

  @@index([projectorModelId])
  @@map("projectors")
}

model ProjectorTransfer {
  id          String   @id @default(uuid())
  projectorId String   @map("projector_id")
  fromSiteId  String?  @map("from_site_id")
  fromAudiId  String?  @map("from_audi_id")
  toSiteId    String   @map("to_site_id")
  toAudiId    String   @map("to_audi_id")
  movedBy     String?  @map("moved_by")
  movedAt     DateTime @default(now()) @map("moved_at")
  reason      String?  @db.Text

  // Relations
  projector Projector @relation(fields: [projectorId], references: [id], onDelete: Cascade)

  @@index([projectorId, movedAt])
  @@map("projector_transfers")
}

model Part {
  id                String   @id @default(uuid())
  partName          String   @map("part_name")
  partNumber        String   @map("part_number")
  projectorModelId  String   @map("projector_model_id")
  category          String?  // e.g., "Lamp", "Lens", "Filter", "Board"
  description       String?  @db.Text
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  projectorModel ProjectorModel @relation(fields: [projectorModelId], references: [id], onDelete: Cascade)

  @@index([projectorModelId])
  @@unique([partNumber, projectorModelId])
  @@map("parts")
}

model Audi {
  id          String   @id @default(uuid())
  audiNo      String   @map("audi_no")
  siteId      String   @map("site_id")
  projectorId String?  @map("projector_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  site      Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)
  projector Projector? @relation(fields: [projectorId], references: [id], onDelete: SetNull)
  dtrCases  DtrCase[]
  rmaCases  RmaCase[]

  @@map("audis")
}

// ============================================
// DTR CASE MANAGEMENT
// ============================================

model DtrCase {
  id               String         @id @default(uuid())
  caseNumber       String         @unique @map("case_number")
  errorDate        DateTime       @map("error_date") @db.Date
  siteId           String         @map("site_id")
  audiId           String         @map("audi_id")
  unitModel        String         @map("unit_model")
  unitSerial       String         @map("unit_serial")
  natureOfProblem  String         @map("nature_of_problem") @db.Text
  actionTaken      String?        @map("action_taken") @db.Text
  remarks          String?        @db.Text
  callStatus       DtrCallStatus  @map("call_status")
  caseSeverity     CaseSeverity   @map("case_severity")
  createdBy        String         @map("created_by")
  assignedTo       String?        @map("assigned_to")
  closedBy         String?        @map("closed_by")
  closedDate       DateTime?      @map("closed_date")
  finalRemarks     String?        @map("final_remarks") @db.Text
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  // Relations
  site             Site           @relation(fields: [siteId], references: [id])
  audi             Audi           @relation(fields: [audiId], references: [id])
  creator          User           @relation("DtrCreatedBy", fields: [createdBy], references: [id])
  assignee         User?          @relation("DtrAssignedTo", fields: [assignedTo], references: [id])
  closer           User?          @relation("DtrClosedBy", fields: [closedBy], references: [id])

  @@index([callStatus])
  @@index([caseSeverity])
  @@index([assignedTo])
  @@index([createdAt])
  @@index([caseNumber])
  @@index([siteId, audiId]) // Composite index for common queries
  @@map("dtr_cases")
}

enum DtrCallStatus {
  open
  in_progress @map("in-progress")
  closed
  escalated
}

enum CaseSeverity {
  low
  medium
  high
  critical
}

// ============================================
// RMA CASE MANAGEMENT
// ============================================

model RmaCase {
  id                      String     @id @default(uuid())
  rmaType                 RmaType    @map("rma_type")
  callLogNumber           String?    @unique @map("call_log_number")  // Numeric value, NOT linked to DTR (unique)
  rmaNumber               String?    @map("rma_number")  // PO Number (optional)
  rmaOrderNumber          String?    @map("rma_order_number")  // Order Number (optional)
  rmaRaisedDate           DateTime   @map("rma_raised_date") @db.Date
  customerErrorDate       DateTime   @map("customer_error_date") @db.Date
  siteId                  String     @map("site_id")
  audiId                  String?    @map("audi_id")
  productName             String     @map("product_name")
  productPartNumber       String     @map("product_part_number")
  serialNumber            String     @map("serial_number")
  defectDetails           String?    @map("defect_details") @db.Text  // Defect description
  defectivePartNumber     String?    @map("defective_part_number")
  defectivePartName       String?    @map("defective_part_name")
  defectivePartSerial     String?    @map("defective_part_serial")
  isDefectivePartDNR      Boolean    @default(false) @map("is_defective_part_dnr")  // Do Not Return
  defectivePartDNRReason  String?    @map("defective_part_dnr_reason") @db.Text  // Why DNR
  replacedPartNumber      String?    @map("replaced_part_number")
  replacedPartSerial      String?    @map("replaced_part_serial")
  symptoms                String?    @db.Text
  shippingCarrier         String?    @map("shipping_carrier")
  trackingNumberOut       String?    @map("tracking_number_out")
  shippedDate             DateTime?  @map("shipped_date") @db.Date
  returnShippedDate       DateTime?  @map("return_shipped_date") @db.Date
  returnTrackingNumber    String?    @map("return_tracking_number")
  returnShippedThrough    String?    @map("return_shipped_through")
  status                  RmaStatus  @default(open)
  createdBy               String     @map("created_by")
  assignedTo              String?    @map("assigned_to")
  notes                   String?    @db.Text
  createdAt               DateTime   @default(now()) @map("created_at")
  updatedAt               DateTime   @updatedAt @map("updated_at")

  // Relations
  site      Site       @relation(fields: [siteId], references: [id])
  audi      Audi?      @relation(fields: [audiId], references: [id])
  creator   User       @relation("RmaCreatedBy", fields: [createdBy], references: [id])
  assignee  User?      @relation("RmaAssignedTo", fields: [assignedTo], references: [id])

  @@index([status])
  @@index([assignedTo])
  @@index([createdAt])
  @@index([rmaRaisedDate])
  @@index([rmaNumber])
  @@index([productPartNumber])
  @@index([defectivePartNumber])
  @@index([status, assignedTo]) // Composite index for common queries
  @@map("rma_cases")
}

enum RmaType {
  RMA
  SRMA
  RMA_CL  @map("RMA CL")
  Lamps
}

enum RmaStatus {
  open                        // Case is open, observation is going on
  rma_raised_yet_to_deliver  @map("rma-raised-yet-to-deliver")  // RMA raised but replacement part yet to deliver to site
  faulty_in_transit_to_cds   @map("faulty-in-transit-to-cds")   // Defective part in transit back to us from site
  closed                      // RMA completed, defective part shipped back to OEM
  cancelled                   // RMA cancelled
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id          String   @id @default(uuid())
  caseId      String   @map("case_id")
  caseType    CaseType @map("case_type")
  action      String
  description String?  @db.Text
  performedBy String   @map("performed_by")
  performedAt DateTime @default(now()) @map("performed_at")

  // Relations
  user User @relation(fields: [performedBy], references: [id])

  @@index([caseId, caseType])
  @@index([performedAt])
  @@map("audit_logs")
}

enum CaseType {
  DTR
  RMA
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  title     String
  message   String           @db.Text
  type      NotificationType
  caseId    String           @map("case_id")
  caseType  CaseType         @map("case_type")
  read      Boolean          @default(false)
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  assignment
  status_change  @map("status-change")
  escalation
  info
}

// ============================================
// NOTIFICATION PREFERENCES
// ============================================

model NotificationPreference {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Email preferences
  emailCaseAssigned     Boolean @default(true) @map("email_case_assigned")
  emailStatusChanged    Boolean @default(true) @map("email_status_changed")
  emailOverdueAlert     Boolean @default(true) @map("email_overdue_alert")
  emailEscalation       Boolean @default(true) @map("email_escalation")
  emailCommentAdded     Boolean @default(false) @map("email_comment_added")
  
  // In-app preferences
  inAppCaseAssigned     Boolean @default(true) @map("in_app_case_assigned")
  inAppStatusChanged    Boolean @default(true) @map("in_app_status_changed")
  inAppOverdueAlert     Boolean @default(true) @map("in_app_overdue_alert")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("notification_preferences")
}

// ============================================
// CASE TEMPLATES
// ============================================

model CaseTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  caseType    String   @map("case_type") // 'DTR' or 'RMA'
  
  // Template data (JSON field)
  templateData Json     @map("template_data")
  
  // Metadata
  createdBy   String   @map("created_by")
  creator     User     @relation("TemplateCreatedBy", fields: [createdBy], references: [id])
  isPublic    Boolean  @default(false) @map("is_public")
  usageCount  Int      @default(0) @map("usage_count")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("case_templates")
}

// ============================================
// SAVED SEARCHES
// ============================================

model SavedSearch {
  id          String   @id @default(uuid())
  name        String
  description String?   @db.Text
  caseType    String   @map("case_type") // 'DTR' or 'RMA' or 'ALL'
  
  // Search criteria (JSON)
  filters     Json
  
  // Metadata
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  isPublic    Boolean  @default(false) @map("is_public")
  usageCount  Int      @default(0) @map("usage_count")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("saved_searches")
}

// ============================================
// AUTO-ASSIGNMENT RULES
// ============================================

model AssignmentRule {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  caseType    String   @map("case_type") // 'DTR' or 'RMA'
  isActive    Boolean  @default(true) @map("is_active")
  priority    Int      @default(0) // Higher priority = checked first
  
  // Rule conditions (JSON)
  conditions  Json     // e.g., { siteId: "xxx", severity: "high" }
  
  // Assignment action
  assignTo    String?  @map("assign_to") // User ID or 'round-robin' or 'least-busy'
  assignToRole String? @map("assign_to_role") // Role name
  
  // Metadata
  createdBy   String   @map("created_by")
  creator     User     @relation("RuleCreatedBy", fields: [createdBy], references: [id])
  matchCount  Int      @default(0) @map("match_count")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("assignment_rules")
}

// ============================================
// FILE ATTACHMENTS
// ============================================

model CaseAttachment {
  id          String   @id @default(uuid())
  fileName    String   @map("file_name")
  filePath    String?  @map("file_path") // Optional: keep for backward compatibility
  fileSize    Int      @map("file_size") // Bytes
  mimeType    String   @map("mime_type")
  caseId      String   @map("case_id")
  caseType    String   @map("case_type") // 'DTR' or 'RMA'
  
  // Cloudinary fields
  cloudinaryUrl      String? @map("cloudinary_url")
  cloudinaryPublicId String? @map("cloudinary_public_id")
  fileType           String? @map("file_type") // 'image', 'log', 'document'
  
  // Metadata
  uploadedBy  String   @map("uploaded_by")
  uploader    User     @relation(fields: [uploadedBy], references: [id])
  description String?  @db.Text
  
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([caseId, caseType])
  @@map("case_attachments")
}

